USE_OCAMLFIND = false

NATIVE_ENABLED = true
BYTE_ENABLED = true

CC_CONFIG = $(shell $(OCAMLC) -config | grep bytecomp_c_compiler:)
CC = $(nth 1, $(CC_CONFIG))
CFLAGS = $(nth-tl 2, $(CC_CONFIG))
CFLAGS += -I$(shell $(OCAMLC) -where)

OCAMLFLAGS = -g -w @A-4-29-41-44-45 -bin-annot
OCAML_OTHER_LIBS = unix
mkdir -p _build
vmount(-l, src, _build)

.SUBDIRS: _build

    section:
        StaticCLibrary(connect, connect)

    section:
        FILES[] =
	    comm
            protocol
	    commands

	OCAML_LIB_FLAGS = -cclib -lbluetooth

	mindstorm-ev3.cmxa mindstorm-ev3.a: $(addsuffix .cmx, $(FILES)) connect.o
		ocamlopt -a -o mindstorm-ev3.cmxa $+ $(OCAML_LIB_FLAGS)

	mindstorm-ev3.cma: $(addsuffix .cmo, $(FILES)) $(addsuffix .cmo, $(FILES)) connect.o
		ocamlc -custom -a -o $@ $+ $(OCAML_LIB_FLAGS)


	.PHONY: install uninstall
	install: uninstall mindstorm-ev3.cmxa mindstorm-ev3.cma
		ocamlfind install mindstorm-ev3 ../META $(addsuffix .*, $(FILES)) mindstorm-ev3.* connect.*

	uninstall:
		ocamlfind remove mindstorm-ev3 || true

    section:
	OCAML_LIBS += mindstorm-ev3
        OCamlProgram(main, main)

        #.DEFAULT: main
