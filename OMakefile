USE_OCAMLFIND = true

NATIVE_ENABLED = true
BYTE_ENABLED = true

CC_CONFIG = $(shell $(OCAMLC) -config | grep bytecomp_c_compiler:)
CC = $(nth 1, $(CC_CONFIG))
CFLAGS = $(nth-tl 2, $(CC_CONFIG))
CFLAGS += -I$(shell $(OCAMLC) -where)

OCAMLFLAGS = -g -w @A-4-29-41-44-45 -bin-annot
mkdir -p _build
vmount(-l, src, _build)

OCAMLPACKS[] = ctypes.foreign

.SUBDIRS: _build

    section:
	OCAML_OTHER_LIBS = unix
        FILES[] =
	    ev3_bluetooth
            ev3_comm
            ev3_protocol
            ev3_commands
            ev3


        OCamlLibrary(mindstorm-ev3, $(FILES))

        .PHONY: install uninstall
        .install.made: ../META mindstorm-ev3.cmxa mindstorm-ev3.a mindstorm-ev3.cma

                ocamlfind remove mindstorm-ev3 || true
                ocamlfind install mindstorm-ev3 ../META $(addsuffix .c*, $(FILES)) *mindstorm-ev3*
                touch $@

        install: .install.made
        uninstall:
		ocamlfind remove mindstorm-ev3 || true

    section:
	OCAMLPACKS[] = mindstorm-ev3

	main.opt: install
	main.byte: install
        OCamlProgram(main, main)

        .DEFAULT: main
